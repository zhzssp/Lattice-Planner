# Lattice-Planner 软件设计说明书

**文档版本**：V1.0  
**软件名称**：Lattice-Planner 个人规划与任务管理系统  
**适用版本**：V1.0  

---

## 第 1 章 概述

### 1.1 编写目的

本设计说明书描述 Lattice-Planner 个人规划与任务管理系统的总体架构、模块划分、接口与数据设计、运行与部署要求，供开发、测试、维护及软件著作权登记文档鉴别材料使用。

### 1.2 软件简介

Lattice-Planner 是一款面向个人的规划与任务管理软件，由服务端 Web 应用与可选桌面客户端（Electron）组成。用户通过浏览器或桌面客户端访问服务端，完成注册与登录后，可进行任务、目标、笔记的管理，并根据思维模式（执行/学习/规划）使用今日看板、规划得分曲线与 AI 总结等功能。桌面客户端在用户登录状态下可定期检查任务截止时间并发送桌面通知提醒。

### 1.3 术语与缩写

| 术语/缩写 | 含义 |
|-----------|------|
| DDL | 截止日期（Deadline） |
| 规划得分 | 按日统计的任务、目标、笔记三维度综合得分（0–100） |
| 思维模式 | 执行（execute）、学习（learn）、规划（plan）三种使用模式 |
| 洞察 | 规划得分曲线与 AI 总结等统计与反馈功能 |
| 插件层 | 通过事件监听扩展核心功能的功能模块（如目标、洞察） |

### 1.4 参考资料

- 项目内《ARCHITECTURE.md》架构说明  
- 项目内《Lattice-Planner 用户手册》（user-manual.md）

---

## 第 2 章 运行环境

### 2.1 服务端运行环境

- **操作系统**：Windows、Linux、macOS 等支持 JDK 的平台。  
- **Java 运行环境**：JDK 17 及以上。  
- **数据库**：MySQL 5.7 或 8.x；需预先创建数据库（如 memo_db），并在应用配置中填写连接地址、用户名、密码及时区等参数。  
- **可选依赖**：若需使用 AI 总结的在线模型，需配置 Gemini API Key（配置文件或环境变量）。

### 2.2 Web 端运行环境

- **浏览器**：Chrome、Edge、Firefox、Safari 等支持现代 HTML5 与 JavaScript 的浏览器。  
- **网络**：能够访问 Lattice-Planner 服务端部署地址（如 http://localhost:8080 或生产域名）。

### 2.3 桌面端运行环境

- **操作系统**：Windows 10/11（当前提供 x64 构建）。  
- **运行方式**：通过 Electron 打包的安装包或绿色包运行，无需单独安装 JDK。  
- **依赖**：需先启动 Lattice-Planner 服务端，桌面端通过配置的 BASE_URL（默认 http://localhost:8080）访问；可通过环境变量 ELECTRON_APP_BASE_URL 修改。

---

## 第 3 章 系统总体设计

### 3.1 系统组成

Lattice-Planner 由以下三部分组成：

1. **服务端**：基于 Spring Boot 的 Web 应用，提供用户认证、任务/目标/笔记的增删改查、用户偏好、思维模式与功能选择、规划得分计算、AI 总结接口等；数据持久化采用 JPA/Hibernate + MyBatis（部分复杂查询）。  
2. **Web 前端**：服务端内嵌的 HTML/CSS/JavaScript 页面与静态资源，通过服务端渲染（如 Thymeleaf 或等价模板）与 REST 接口配合，实现登录、看板、任务/目标/笔记管理、偏好设置、洞察（得分曲线与 AI 总结）等界面。  
3. **桌面客户端（Lattice-Planner 客户端）**：基于 Electron 的桌面应用，内嵌浏览器加载服务端 URL，提供系统托盘、单实例、窗口隐藏到托盘、定时检查登录状态与任务截止日期并发送桌面通知（1 天内、3 天内、已过期）等功能。

### 3.2 总体架构原则

- **核心与插件解耦**：核心层仅包含用户、任务、笔记、链接等实体及任务基础服务，不依赖任何业务插件；扩展功能（目标、洞察）通过 Spring 事件监听实现，核心通过发布事件与插件交互。  
- **前后端一体部署**：Web 前端与后端同工程部署，减少跨域与部署复杂度；桌面端通过同一后端地址访问，会话通过 Cookie 保持。  
- **文档与代码一致**：本说明书描述与当前 V1.0 实现一致，不包含未实现功能。

### 3.3 技术选型概览

| 层次 | 技术 |
|------|------|
| 服务端框架 | Spring Boot、Spring Security、Spring MVC |
| 数据访问 | JPA/Hibernate、MyBatis（部分） |
| 数据库 | MySQL |
| 前端 | HTML、CSS、JavaScript，服务端模板渲染 |
| 桌面端 | Electron、Node.js、Axios |
| 可选 AI | Google Gemini API（google-genai SDK），本地规则兜底 |

---

## 第 4 章 核心层设计

### 4.1 包结构与职责

核心层包含极简的业务实体和基础服务，不依赖任何插件。

- **entity**：User、Task、Note、Link 及与任务相关的枚举（TaskStatus、EnergyLevel、MentalLoad、TimeSlot、TaskGranularity、NoteType 等）。  
- **core/event**：TaskCreatedEvent、TaskCompletedEvent、TaskArchivedEvent，在任务创建、完成、归档时由核心服务发布。  
- **core/service**：TaskService，负责任务的创建、完成、搁置、归档及事件发布。  
- **repository**：TaskRepository、UserRepository、NoteRepository、LinkRepository 等数据访问接口。

### 4.2 核心实体说明

**User**：用户实体，主要属性包括 id、username（唯一）、password（存储加密后密码）。  

**Task**：任务实体，表名兼容为 memo。主要属性：id、title、description、deadline（截止时间）、status（PENDING/DONE/SHELVED 等）、granularity、energyRequirement（精力需求）、mentalLoad（心理负担）、preferredSlot（期望时间段）、estimatedMinutes、createdAt、shelvedAt、user。任务归属以 deadline 所在日期为准参与规划得分统计。  

**Note**：笔记实体，属性包括 id、title、content、type、createdAt、updatedAt、user。  

**Link**：弱关联实体，表达多对多关系。属性包括 sourceType/sourceId（源类型与 ID）、targetType/targetId（目标类型与 ID）、createdAt。用于任务与目标、任务与笔记等关联，供插件层与得分计算使用。

### 4.3 事件发布机制

核心服务在关键操作时发布领域事件，插件通过监听事件扩展行为而不修改核心代码。  

- 任务创建：TaskService 保存任务后发布 TaskCreatedEvent。  
- 任务完成：TaskService 将任务状态置为 DONE 并保存后发布 TaskCompletedEvent。  
- 任务归档：TaskService 归档后发布 TaskArchivedEvent。  

事件对象携带任务实体及操作用户等信息，供 Goal、Insight 等插件使用。

---

## 第 5 章 插件层设计

### 5.1 插件层原则

- 插件依赖核心，核心不依赖插件。  
- 通过 @EventListener 监听核心事件，实现目标进度更新、统计等扩展逻辑。  
- 各插件之间独立，互不依赖。

### 5.2 目标插件（feature/goal）

- **实体**：Goal，属性包括 id、name、goalType、createdAt、archivedAt、user。  
- **Repository**：GoalRepository。  
- **Service**：GoalService，负责目标的创建、归档、删除及与任务的关联维护。  
- **Controller**：GoalController，提供目标的 Web 接口与页面数据。  
- **Listener**：GoalEventListener，监听 TaskCompletedEvent、TaskCreatedEvent、TaskArchivedEvent 等，更新目标进度或做后续扩展。  

任务与目标的关联通过 Link 表或任务表中外键/关联字段实现（依具体实现为准），目标进度由插件根据关联任务完成情况计算。

### 5.3 洞察插件（feature/insight）

洞察插件提供规划得分计算与 AI 总结，不修改核心数据模型，仅读取任务、目标、笔记、链接等数据。

- **InsightScoreService**：按日期区间计算每日规划得分。输入为当前用户、起始日、结束日；输出为 DailyScore 列表，包含 date、totalScore、taskScore、goalScore、noteScore 及辅助统计字段。  
  - 任务维度（约 0–70 分）：按任务截止日期归属，根据精力需求、心理负担、任务周期等计算权重，再结合完成情况与吞吐量因子得到任务得分。  
  - 目标维度（约 0–20 分）：根据目标进度、当日完成目标数、当日有推进的目标数等计算。  
  - 笔记维度（约 0–10 分）：根据当日笔记条数经递减增益函数映射。  
  DailyScore 仅在内存中生成，不持久化。  

- **AiSummaryService**：对给定日期区间内的 DailyScore 列表生成自然语言总结。采用双通路：优先使用配置的 Gemini API 生成总结；无 API Key 或调用超时/异常时，使用本地规则模板生成总结，保证功能始终可用。  

- **InsightController**：提供 REST 接口，如 GET /insight/score（参数 start、end）、GET /insight/score/summary（参数 start、end），供前端请求得分数据与 AI 总结。

---

## 第 6 章 用户与安全设计

### 6.1 认证与授权

- 使用 Spring Security 进行认证与授权。  
- 登录方式：表单登录，登录页 /login，登录成功后默认跳转至功能选择/看板。  
- 密码存储：BCrypt 加密后存入数据库。  
- 会话：基于 HTTP Session，Cookie 名称 JSESSIONID，供 Web 与桌面端统一保持登录状态。

### 6.2 接口访问控制

- 允许匿名访问：/register、/login、静态资源、/user-logged-in（供桌面端查询登录状态）。  
- 需认证访问：/dashboard、/memo/*、/goal/*、/note/*、/insight/*、/preference/*、/select-features 等业务接口。  
- 特殊接口：/due-dates 供桌面端拉取待提醒任务，在 CSRF 豁免列表中，但仍需通过 Cookie 携带会话以区分用户。

### 6.3 用户偏好与功能选择

- **UserPreference**：存储每用户偏好，如 maxVisibleTasks、showFutureTasks、showStatistics 等。  
- **思维模式**：通过 FeatureSelectionController 与 Session 维护当前模式（execute/learn/plan），规划模式下可访问洞察相关页面；是否显示统计入口还受 showStatistics 控制。

---

## 第 7 章 主要接口与 API 设计

### 7.1 认证相关

- GET /login：登录页。  
- POST /login：表单登录提交。  
- GET /register：注册页。  
- POST /register：注册提交。  
- GET /user-logged-in：返回当前是否已登录（供桌面端轮询）。

### 7.2 任务相关

- GET /dashboard：今日看板页，支持参数 taskView（如 today、time、energy）等。  
- GET/POST /memo/*：任务的列表、创建、编辑、完成、搁置、删除等（具体 URL 以代码为准）。  
- GET /due-dates：返回当前用户未完成且带截止日期的任务列表，供桌面端 DDL 提醒使用。

### 7.3 目标与笔记

- GET/POST 目标相关路径：目标的列表、创建、归档、删除等。  
- GET/POST 笔记相关路径：笔记的列表、创建、查看、编辑等。

### 7.4 洞察（统计与 AI 总结）

- GET /insight/score?start=&end=：返回指定日期区间内每日得分列表（JSON）。  
- GET /insight/score/summary?start=&end=：返回该区间的 AI 总结（JSON），内含总结文本及是否使用本地总结等标识。

### 7.5 偏好与功能选择

- GET/POST 用户偏好接口：读取与保存 UserPreference。  
- GET/POST 功能选择/模式切换：设置并保存当前思维模式。

---

## 第 8 章 数据与持久化设计

### 8.1 数据库与表

- 使用 MySQL，由应用配置指定数据源。  
- 主要表：user、memo（任务）、note、link、goal、用户偏好表（具体表名以实体 @Table 为准）。  
- 采用 JPA ddl-auto=update 时，表结构随实体变更自动更新（生产环境建议改为 validate 并配合迁移脚本）。

### 8.2 关键实体与表对应

- User → user 表。  
- Task → memo 表。  
- Note → note 表。  
- Link → link 表。  
- Goal → goal 表。  
- UserPreference → 对应偏好表。

### 8.3 规划得分与 AI 总结数据

- 规划得分（DailyScore）不落库，每次请求时由 InsightScoreService 根据任务、目标、笔记、链接实时计算。  
- AI 总结结果不持久化，仅返回给前端展示；若未来扩展历史总结可考虑增加持久化表。

---

## 第 9 章 桌面客户端设计

### 9.1 功能概述

Lattice-Planner 桌面客户端（Electron）提供：  
- 使用系统托盘常驻，主窗口关闭时隐藏到托盘而非退出。  
- 单实例：已有一例运行时再次启动则激活已有窗口。  
- 内嵌浏览器加载服务端 BASE_URL，与 Web 共用同一套登录与业务。  
- 定时（如每分钟）向服务端请求 /user-logged-in 与 /due-dates；对未完成且带截止日期的任务，按「已过期」「1 天内」「3 天内」规则发送桌面通知，且同一任务在同一天内不重复提醒（通过内存集合去重，每日清零）。

### 9.2 技术要点

- 主进程：创建 BrowserWindow、Tray、Notification；处理 ipc 消息（如 reload-app）；定时调用 axios 请求 /user-logged-in、/due-dates，Cookie 从 webContents.session.cookies 获取并随请求携带。  
- 预加载脚本：通过 contextBridge 向页面暴露 latticePlanner.reload() 等少量接口；接收主进程下发的 login-status、notification、grant 等消息。  
- 错误处理：加载失败时显示本地错误页，提示用户确认服务端已启动并可重试。

### 9.3 配置与部署

- 后端地址：环境变量 ELECTRON_APP_BASE_URL，默认 http://localhost:8080。  
- 打包：使用 electron-packager 或 electron-builder 生成 Windows x64 安装包或绿色包；图标与资源按项目配置打包。

---

## 第 10 章 部署与配置说明

### 10.1 服务端部署

- 安装 JDK 17+、MySQL，创建数据库。  
- 配置 application.properties（或 application.yml）：数据源 URL、用户名、密码、会话超时、MyBatis mapper 位置等。  
- 可选：配置 gemini.api.key 或环境变量 GEMINI_API_KEY/GOOGLE_API_KEY 以启用 AI 在线总结。  
- 启动 Spring Boot 应用，默认端口 8080（可配置 server.port）。  
- 若需对外提供 Web 与桌面端访问，需保证防火墙与反向代理（如有）放行相应端口与路径。

### 10.2 桌面端分发

- 将 Electron 工程打包为 Windows 安装包或绿色版，随包提供使用说明（需先启动服务端、配置 BASE_URL 等）。  
- 用户安装或解压后运行，首次使用需在客户端内完成服务端登录，方可收到 DDL 提醒。

### 10.3 安全与运维建议

- 生产环境应使用强密码、HTTPS、限制数据库访问来源。  
- 会话超时、Cookie 安全属性（如 secure、httpOnly、sameSite）按需在配置中调整。  
- API Key 等敏感信息通过环境变量或加密配置管理，不要提交到版本库。

---

## 第 11 章 扩展与维护说明

### 11.1 扩展新插件

- 在 feature/ 下新建子包（如 feature/xxx）。  
- 定义实体、Repository、Service、Controller；如需响应核心事件，增加 @EventListener 监听 TaskCreatedEvent、TaskCompletedEvent、TaskArchivedEvent 等。  
- 核心层无需修改，仅通过事件与插件协作。

### 11.2 得分与 AI 扩展建议

- 得分权重与公式可在 InsightScoreService 中调整。  
- AI 总结可扩展为多模型支持：在 AiSummaryService 外增加 LLM Provider 抽象，便于切换或增加其他大模型。  
- 若需多语言，可在配置与前端中增加语言选项，并在 AI 总结 prompt 中指定语言。

---

## 第 12 章 文档与版本

- 本设计说明书与 Lattice-Planner V1.0 实现保持一致。  
- 若后续版本有架构或接口变更，应同步更新本说明书及用户手册，并更新版本号与修订记录。

---

**文档结束**
