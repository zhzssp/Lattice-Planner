<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>偏好设置</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body class="preference-settings-page" th:classappend="${theme == 'dark'} ? 'theme-dark' : ''" th:attr="data-selected-mode=${selectedMode}">
<div class="container">
    <div class="preference-header">
        <h2>偏好设置</h2>
        <button type="button" class="reset-btn" id="resetPreferenceBtn">恢复默认设置</button>
    </div>
    <p class="preference-intro">先选择要设置的思维模式，再修改该模式下可用的选项，避免混淆。</p>

    <form th:action="@{/preference/update}" method="post" id="preferenceForm">
        <!-- 通用：与具体模式无关 -->
        <section class="preference-section preference-section-common">
            <h3>通用</h3>
            <div class="preference-item">
                <label for="theme">背景亮/暗</label>
                <select id="theme" name="theme">
                    <option value="light" th:selected="${preference.theme == null or preference.theme == 'light'}">亮色</option>
                    <option value="dark" th:selected="${preference.theme == 'dark'}">暗色</option>
                </select>
            </div>
            <p class="preference-desc">切换思维模式或首次选择时，选择页将预选此项。</p>
            <div class="preference-item">
                <label for="defaultMindsetMode">默认思维模式</label>
                <select id="defaultMindsetMode" name="defaultMindsetMode">
                    <option value="">不指定（每次手动选择）</option>
                    <option value="EXECUTE" th:selected="${preference.defaultMindsetMode != null and preference.defaultMindsetMode.name() == 'EXECUTE'}">执行模式</option>
                    <option value="LEARN" th:selected="${preference.defaultMindsetMode != null and preference.defaultMindsetMode.name() == 'LEARN'}">学习模式</option>
                    <option value="PLAN" th:selected="${preference.defaultMindsetMode != null and preference.defaultMindsetMode.name() == 'PLAN'}">规划模式</option>
                </select>
            </div>
        </section>

        <!-- 选择要设置哪个思维模式的偏好 -->
        <section class="preference-section">
            <h3>选择要设置的思维模式</h3>
            <div class="preference-mode-tabs" role="tablist">
                <button type="button" class="mode-tab" role="tab" data-mode="execute" aria-selected="false">执行模式</button>
                <button type="button" class="mode-tab" role="tab" data-mode="learn" aria-selected="false">学习模式</button>
                <button type="button" class="mode-tab" role="tab" data-mode="plan" aria-selected="false">规划模式</button>
            </div>

            <div class="preference-mode-panel">
                <!-- 每屏任务数：执行、学习、规划均可用 -->
                <div class="preference-row" data-modes="execute learn plan">
                    <div class="preference-item">
                        <label for="maxVisibleTasks">每屏最多显示任务数（留空表示不限制）</label>
                        <input type="number" id="maxVisibleTasks" name="maxVisibleTasks" min="1" step="1"
                               th:value="${preference.maxVisibleTasks}">
                    </div>
                </div>
                <!-- 显示未来任务：学习、规划 -->
                <div class="preference-row" data-modes="learn plan">
                    <div class="preference-item">
                        <label>
                            <input type="checkbox" name="showFutureTasks" value="true"
                                   th:checked="${preference.showFutureTasks}">
                            显示未来任务
                        </label>
                    </div>
                </div>
                <!-- 以下仅规划模式 -->
                <div class="preference-row" data-modes="plan">
                    <div class="preference-item">
                        <label for="defaultTaskView">进入规划模式时默认视图</label>
                        <select id="defaultTaskView" name="defaultTaskView">
                            <option value="" th:selected="${preference.defaultTaskView == null or preference.defaultTaskView == '' or preference.defaultTaskView == 'today'}">今日视图</option>
                            <option value="slot" th:selected="${preference.defaultTaskView == 'slot'}">时间段视图</option>
                            <option value="energy" th:selected="${preference.defaultTaskView == 'energy'}">精力视图</option>
                        </select>
                    </div>
                </div>
                <div class="preference-row" data-modes="plan">
                    <div class="preference-item">
                        <label>
                            <input type="checkbox" name="showStatistics" value="true"
                                   th:checked="${preference.showStatistics}">
                            显示统计信息（完成率等）
                        </label>
                    </div>
                </div>
                <div class="preference-row" data-modes="plan">
                    <div class="preference-item">
                        <label>
                            <input type="checkbox" name="showGoals" value="true"
                                   th:checked="${preference.showGoals != null ? preference.showGoals : true}">
                            显示目标管理区块
                        </label>
                    </div>
                </div>
                <div class="preference-row" data-modes="plan">
                    <div class="preference-item">
                        <label>
                            <input type="checkbox" name="showScoreSection" value="true"
                                   th:checked="${preference.showScoreSection != null ? preference.showScoreSection : true}">
                            显示规划完成得分曲线
                        </label>
                    </div>
                </div>
                <div class="preference-row" data-modes="plan">
                    <div class="preference-item">
                        <label>
                            <input type="checkbox" name="showFuzzyHint" value="true"
                                   th:checked="${preference.showFuzzyHint != null ? preference.showFuzzyHint : true}">
                            显示「需要拆分的模糊任务」提示
                        </label>
                    </div>
                </div>
                <div class="preference-row" data-modes="plan">
                    <div class="preference-item">
                        <label>
                            <input type="checkbox" name="showArchivedSection" value="true"
                                   th:checked="${preference.showArchivedSection != null ? preference.showArchivedSection : true}">
                            显示归档/搁置任务区块
                        </label>
                    </div>
                </div>
                <div class="preference-row" data-modes="plan">
                    <div class="preference-item">
                        <label for="fuzzyTaskDaysThreshold">模糊任务存在超过 N 天提示拆分（0 表示不提示）</label>
                        <input type="number" id="fuzzyTaskDaysThreshold" name="fuzzyTaskDaysThreshold" min="0" step="1"
                               th:value="${preference.fuzzyTaskDaysThreshold != null ? preference.fuzzyTaskDaysThreshold : 5}">
                    </div>
                </div>
            </div>
        </section>

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="preference-actions">
            <button type="submit" class="add-btn">保存设置</button>
            <a href="/dashboard" class="add-btn">返回</a>
        </div>
    </form>
</div>
<script>
(function() {
    var page = document.querySelector('.preference-settings-page');
    var selectedMode = (page && page.getAttribute('data-selected-mode')) || 'execute';
    var tabs = document.querySelectorAll('.mode-tab');
    var rows = document.querySelectorAll('.preference-row[data-modes]');

    function showForMode(mode) {
        selectedMode = mode;
        tabs.forEach(function(t) {
            var isActive = t.getAttribute('data-mode') === mode;
            t.classList.toggle('active', isActive);
            t.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        rows.forEach(function(row) {
            var modes = (row.getAttribute('data-modes') || '').split(/\s+/);
            row.style.display = modes.indexOf(mode) !== -1 ? '' : 'none';
        });
    }

    tabs.forEach(function(t) {
        t.addEventListener('click', function() {
            showForMode(this.getAttribute('data-mode'));
        });
    });

    showForMode(selectedMode);

    // 恢复默认设置：只重置当前页面表单的值，不提交到后端
    var resetBtn = document.getElementById('resetPreferenceBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            var theme = document.getElementById('theme');
            var defaultMindsetMode = document.getElementById('defaultMindsetMode');
            var maxVisibleTasks = document.getElementById('maxVisibleTasks');
            var showFutureTasks = document.querySelector('input[name="showFutureTasks"]');
            var showStatistics = document.querySelector('input[name="showStatistics"]');
            var showGoals = document.querySelector('input[name="showGoals"]');
            var showScoreSection = document.querySelector('input[name="showScoreSection"]');
            var showFuzzyHint = document.querySelector('input[name="showFuzzyHint"]');
            var showArchivedSection = document.querySelector('input[name="showArchivedSection"]');
            var defaultTaskView = document.getElementById('defaultTaskView');
            var fuzzyTaskDaysThreshold = document.getElementById('fuzzyTaskDaysThreshold');

            if (theme) theme.value = 'light';
            if (defaultMindsetMode) defaultMindsetMode.value = '';
            if (maxVisibleTasks) maxVisibleTasks.value = '';

            if (showFutureTasks) showFutureTasks.checked = true;
            if (showStatistics) showStatistics.checked = true;
            if (showGoals) showGoals.checked = true;
            if (showScoreSection) showScoreSection.checked = true;
            if (showFuzzyHint) showFuzzyHint.checked = true;
            if (showArchivedSection) showArchivedSection.checked = true;

            if (defaultTaskView) defaultTaskView.value = '';
            if (fuzzyTaskDaysThreshold) fuzzyTaskDaysThreshold.value = '5';
        });
    }
})();
</script>
</body>
</html>
